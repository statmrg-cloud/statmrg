{% extends "base.html" %}
{% block title %}ìƒì„± ê²°ê³¼ - ì „ìì±… ìƒì„±ê¸°{% endblock %}
{% block content %}
<div class="page-header">
  <h2>ì „ìì±… ìƒì„± ê²°ê³¼</h2>
  <div style="display:flex;gap:8px;">
    <a href="/edit/{{ task_id }}" class="btn btn-primary" id="editBtn">ë‚´ìš© í¸ì§‘</a>
    <a href="/" class="btn">ìƒˆë¡œ ë§Œë“¤ê¸°</a>
  </div>
</div>

<div id="resultLoading" class="card" style="text-align:center;">
  <div class="spinner"></div>
  <p style="margin-top:16px;">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<div id="resultContent" style="display:none;">

  <!-- ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ -->
  <div class="card" id="downloadSection" style="display:none;">
    <h3 class="card-title">íŒŒì¼ ë‹¤ìš´ë¡œë“œ</h3>
    <div id="bookTitleDisplay" style="font-size:18px;font-weight:700;margin-bottom:4px;"></div>
    <div id="bookSubtitleDisplay" class="text-muted" style="margin-bottom:16px;"></div>
    <div class="download-buttons" id="downloadButtons"></div>

    <!-- í˜•ì‹ ì¶”ê°€ ì¬ìƒì„± -->
    <div style="margin-top:16px;padding-top:16px;border-top:1px solid #eee;">
      <label style="font-size:13px;color:#666;display:block;margin-bottom:8px;">ì¶”ê°€ í˜•ì‹ìœ¼ë¡œ ì¬ìƒì„±</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-sm" onclick="regenerate('pdf')">PDF ì¬ìƒì„±</button>
        <button class="btn btn-sm" onclick="regenerate('docx')">DOCX ì¬ìƒì„±</button>
        <button class="btn btn-sm" onclick="regenerate('pptx')">PPTX ì¬ìƒì„±</button>
        <button class="btn btn-sm" onclick="regenerate('hwpx')">HWP ì¬ìƒì„±</button>
      </div>
      <div id="regenStatus" style="margin-top:8px;font-size:13px;"></div>
    </div>
  </div>

  <!-- ë¶„ì„ ê²°ê³¼ -->
  <div class="card" id="analysisSection">
    <h3 class="card-title">ìœ ë£Œ ê°€ì¹˜ ë¶„ì„</h3>
    <div id="analysisContent"></div>
  </div>

  <!-- ëª©ì°¨ -->
  <div class="card" id="tocSection">
    <h3 class="card-title">ëª©ì°¨ êµ¬ì¡° (<span id="chaptersCount">0</span>ì±•í„°)</h3>
    <div id="tocContent"></div>
  </div>

  <!-- ë…ì ì‹¬ë¦¬ ë¶„ì„ -->
  <div class="card" id="psychologySection">
    <h3 class="card-title">êµ¬ë§¤ì ì‹¬ë¦¬ ë¶„ì„</h3>
    <div id="psychologyContent"></div>
  </div>

  <!-- ë§ˆì¼€íŒ… -->
  <div class="card" id="marketingSection">
    <h3 class="card-title">ë§ˆì¼€íŒ… &amp; ìì—° ìœ í†µ ì „ëµ</h3>
    <div id="marketingContent"></div>
  </div>

  <!-- íŒë§¤ ì†Œê°œë¬¸ -->
  <div class="card highlight-card" id="salesSection">
    <h3 class="card-title">íŒë§¤ ì†Œê°œë¬¸ (ë³µì‚¬í•´ì„œ ë°”ë¡œ ì‚¬ìš©)</h3>
    <div id="salesCopy" class="sales-copy-box"></div>
    <button class="btn btn-sm" id="copySalesBtn">ë³µì‚¬í•˜ê¸°</button>
  </div>
</div>

<div id="errorSection" class="card" style="display:none;">
  <div class="text-error" style="text-align:center;">
    <h3>ìƒì„± ì‹¤íŒ¨</h3>
    <p id="errorMessage"></p>
    <a href="/" class="btn btn-primary" style="margin-top:16px;">ë‹¤ì‹œ ì‹œë„</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var TASK_ID = '{{ task_id }}';

var FORMAT_LABELS = { pdf: 'PDF', docx: 'DOCX', pptx: 'PPTX', hwpx: 'HWP' };
var FORMAT_ICONS  = { pdf: 'ğŸ“„', docx: 'ğŸ“', pptx: 'ğŸ“Š', hwpx: 'ğŸ“‹' };

function renderDownloadButtons(generatedFiles) {
  var container = document.getElementById('downloadButtons');
  container.innerHTML = '';
  var hasAny = false;
  Object.keys(generatedFiles).forEach(function(fmt) {
    var fn = generatedFiles[fmt];
    if (!fn) return;
    hasAny = true;
    var a = document.createElement('a');
    a.href = '/api/download/' + encodeURIComponent(fn);
    a.className = 'btn btn-primary download-btn';
    a.innerHTML = (FORMAT_ICONS[fmt] || '') + ' ' + (FORMAT_LABELS[fmt] || fmt.toUpperCase()) + ' ë‹¤ìš´ë¡œë“œ';
    a.setAttribute('download', fn);
    container.appendChild(a);
  });
  if (!hasAny) {
    container.innerHTML = '<p class="text-muted">ìƒì„±ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
  }
}

async function regenerate(fmt) {
  var statusEl = document.getElementById('regenStatus');
  statusEl.textContent = fmt.toUpperCase() + ' ìƒì„± ì¤‘...';
  try {
    var res = await fetch('/api/regenerate_format/' + TASK_ID, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ format: fmt })
    });
    var d = await res.json();
    if (d.success) {
      statusEl.innerHTML = '<span style="color:#03c75a;">' + fmt.toUpperCase() + ' ìƒì„± ì™„ë£Œ!</span>';
      // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ê°±ì‹ 
      var res2 = await fetch('/api/result/' + TASK_ID);
      var d2 = await res2.json();
      if (d2.success) renderDownloadButtons(d2.data.generated_files || {});
    } else {
      statusEl.innerHTML = '<span style="color:#e74c3c;">ì‹¤íŒ¨: ' + d.error + '</span>';
    }
  } catch(e) {
    statusEl.innerHTML = '<span style="color:#e74c3c;">ì˜¤ë¥˜: ' + e.message + '</span>';
  }
}

async function loadResult() {
  try {
    var res = await fetch('/api/result/' + TASK_ID);
    var json = await res.json();
    document.getElementById('resultLoading').style.display = 'none';

    if (!json.success || json.data.error) {
      document.getElementById('errorSection').style.display = 'block';
      document.getElementById('errorMessage').textContent = json.data ? json.data.error : 'ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      return;
    }

    var d = json.data;
    document.getElementById('resultContent').style.display = 'block';

    // ë‹¤ìš´ë¡œë“œ ì„¹ì…˜
    var gf = d.generated_files || {};
    if (d.pdf_filename && !gf.pdf) gf.pdf = d.pdf_filename;
    if (Object.keys(gf).length > 0) {
      document.getElementById('downloadSection').style.display = 'block';
      renderDownloadButtons(gf);
    }

    // ì œëª©
    var info = d.book_info || {};
    document.getElementById('bookTitleDisplay').textContent = info.book_title || d.topic;
    document.getElementById('bookSubtitleDisplay').textContent = info.subtitle || '';

    // ì±•í„° ìˆ˜
    document.getElementById('chaptersCount').textContent = d.chapters_count || 0;

    // ë¶„ì„ ê²°ê³¼
    var analysis = d.analysis || {};
    var aHtml = '';
    if (analysis.free_vs_paid) {
      aHtml += '<div class="analysis-item"><strong>ìœ ë£Œ ì „í™˜ íŒë‹¨:</strong> ' + (analysis.free_vs_paid.verdict || '') + '</div>';
      if (analysis.free_vs_paid.paid_conversion_points) {
        aHtml += '<div class="analysis-item"><strong>ìœ ë£Œ ì „í™˜ í¬ì¸íŠ¸:</strong><ul>';
        analysis.free_vs_paid.paid_conversion_points.forEach(function(p) { aHtml += '<li>' + p + '</li>'; });
        aHtml += '</ul></div>';
      }
    }
    if (analysis.problem_solved) {
      var ps = analysis.problem_solved;
      aHtml += '<div class="value-grid">';
      aHtml += '<div class="value-item"><span class="value-label">ì‹œê°„ ì ˆì•½</span><span class="value-text">' + (ps.time || '') + '</span></div>';
      aHtml += '<div class="value-item"><span class="value-label">ë¹„ìš© ì ˆê°</span><span class="value-text">' + (ps.money || '') + '</span></div>';
      aHtml += '<div class="value-item"><span class="value-label">ê°ì • í•´ê²°</span><span class="value-text">' + (ps.emotion || '') + '</span></div>';
      aHtml += '</div>';
    }
    if (analysis.why_pay) {
      aHtml += '<div class="analysis-item highlight"><strong>ì™œ ëˆ ì£¼ê³  ì‚¬ì•¼ í•˜ëŠ”ê°€:</strong><p>' + analysis.why_pay + '</p></div>';
    }
    document.getElementById('analysisContent').innerHTML = aHtml;

    // ëª©ì°¨
    var chapters = info.chapters || [];
    var phaseColors = { 'ë¬¸ì œì¸ì‹': '#e74c3c', 'ë°©ë²•ë°œê²¬': '#f39c12', 'ì‹¤í–‰': '#03c75a', 'í™•ì‹ ': '#3498db' };
    var tHtml = '<div class="toc-list">';
    chapters.forEach(function(ch) {
      var color = phaseColors[ch.phase] || '#333';
      tHtml += '<div class="toc-item">';
      tHtml += '<span class="toc-phase" style="background:' + color + '">' + ch.phase + '</span>';
      tHtml += '<span class="toc-num">CH.' + ch.chapter_num + '</span>';
      tHtml += '<span class="toc-title">' + ch.title + '</span>';
      tHtml += '</div>';
    });
    tHtml += '</div>';
    document.getElementById('tocContent').innerHTML = tHtml;

    // ë…ì ì‹¬ë¦¬
    var psych = info.reader_psychology || {};
    var pHtml = '<div class="psychology-grid">';
    if (psych.concerns) {
      pHtml += '<div class="psych-col"><h4>ê³ ë¯¼</h4><ul>';
      psych.concerns.forEach(function(c) { pHtml += '<li>' + c + '</li>'; });
      pHtml += '</ul></div>';
    }
    if (psych.expectations) {
      pHtml += '<div class="psych-col"><h4>ê¸°ëŒ€</h4><ul>';
      psych.expectations.forEach(function(e) { pHtml += '<li>' + e + '</li>'; });
      pHtml += '</ul></div>';
    }
    if (psych.fears) {
      pHtml += '<div class="psych-col"><h4>ë‘ë ¤ì›€</h4><ul>';
      psych.fears.forEach(function(f) { pHtml += '<li>' + f + '</li>'; });
      pHtml += '</ul></div>';
    }
    pHtml += '</div>';
    document.getElementById('psychologyContent').innerHTML = pHtml;

    // ë§ˆì¼€íŒ…
    var mkt = d.marketing || {};
    var mHtml = '';
    if (mkt.content_topics) {
      mHtml += '<h4>ì½˜í…ì¸  ì—°ê²° ì „ëµ (5ê°œ)</h4><div class="content-topics">';
      mkt.content_topics.forEach(function(ct, i) {
        mHtml += '<div class="topic-item"><span class="topic-num">' + (i+1) + '</span>';
        mHtml += '<div><strong>' + ct.topic + '</strong><p class="hook-text">"' + ct.hook_sentence + '"</p></div></div>';
      });
      mHtml += '</div>';
    }
    if (mkt.natural_distribution) {
      var nd = mkt.natural_distribution;
      mHtml += '<div class="distribution-grid">';
      if (nd.blog_questions) { mHtml += '<div><h4>ë¸”ë¡œê·¸ ì§ˆë¬¸</h4><ul>'; nd.blog_questions.forEach(function(q){mHtml+='<li>'+q+'</li>';}); mHtml+='</ul></div>'; }
      if (nd.community_complaints) { mHtml += '<div><h4>ì»¤ë®¤ë‹ˆí‹° ë¶ˆë§Œ</h4><ul>'; nd.community_complaints.forEach(function(q){mHtml+='<li>'+q+'</li>';}); mHtml+='</ul></div>'; }
      if (nd.sns_consumption) { mHtml += '<div><h4>SNS ì†Œë¹„</h4><ul>'; nd.sns_consumption.forEach(function(q){mHtml+='<li>'+q+'</li>';}); mHtml+='</ul></div>'; }
      mHtml += '</div>';
    }
    document.getElementById('marketingContent').innerHTML = mHtml;

    // íŒë§¤ ì†Œê°œë¬¸
    if (mkt.sales_copy) {
      document.getElementById('salesCopy').textContent = mkt.sales_copy;
    }

  } catch(e) {
    document.getElementById('resultLoading').style.display = 'none';
    document.getElementById('errorSection').style.display = 'block';
    document.getElementById('errorMessage').textContent = 'ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
  }
}

document.getElementById('copySalesBtn').addEventListener('click', function() {
  var text = document.getElementById('salesCopy').textContent;
  navigator.clipboard.writeText(text).then(function() {
    document.getElementById('copySalesBtn').textContent = 'ë³µì‚¬ë¨!';
    setTimeout(function() { document.getElementById('copySalesBtn').textContent = 'ë³µì‚¬í•˜ê¸°'; }, 2000);
  });
});

loadResult();
</script>
{% endblock %}
